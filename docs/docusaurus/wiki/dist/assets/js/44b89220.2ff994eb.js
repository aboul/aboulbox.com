"use strict";(self.webpackChunkwiki=self.webpackChunkwiki||[]).push([[8062],{2141:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>l,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"Services/caddy","title":"Caddy","description":"Reverse Proxy","source":"@site/docs/Services/caddy.md","sourceDirName":"Services","slug":"/Services/caddy","permalink":"/Services/caddy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"Reverse Proxy"},"sidebar":"tutorialSidebar","previous":{"title":"Backend","permalink":"/Services/backend"},"next":{"title":"Database","permalink":"/Services/database"}}');var r=s(4848),t=s(8453);const l={description:"Reverse Proxy"},c="Caddy",a={},d=[{value:"R\xf4le dans la stack",id:"r\xf4le-dans-la-stack",level:2},{value:"Position dans l&#39;architecture",id:"position-dans-larchitecture",level:2},{value:"Responsabilit\xe9s principales",id:"responsabilit\xe9s-principales",level:2},{value:"Reverse Proxy",id:"reverse-proxy",level:3},{value:"TLS automatique",id:"tls-automatique",level:3},{value:"Authentification avec Authelia",id:"authentification-avec-authelia",level:3},{value:"Gestion des routes publiques",id:"gestion-des-routes-publiques",level:3},{value:"S\xe9curit\xe9 et bonnes pratiques",id:"s\xe9curit\xe9-et-bonnes-pratiques",level:3},{value:"Int\xe9gration Docker",id:"int\xe9gration-docker",level:2},{value:"R\xe9seau",id:"r\xe9seau",level:3},{value:"Ports expos\xe9s",id:"ports-expos\xe9s",level:3},{value:"Avantages de ce setup",id:"avantages-de-ce-setup",level:2},{value:"Points d&#39;attention",id:"points-dattention",level:2},{value:"Am\xe9liorations possibles",id:"am\xe9liorations-possibles",level:2},{value:"R\xe9sum\xe9",id:"r\xe9sum\xe9",level:2},{value:"Caddyfile \u2013 Conventions du repository",id:"caddyfile--conventions-du-repository",level:2},{value:"Principes g\xe9n\xe9raux",id:"principes-g\xe9n\xe9raux",level:3},{value:"Structure globale",id:"structure-globale",level:3},{value:"Convention par service",id:"convention-par-service",level:3}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"caddy",children:"Caddy"})}),"\n",(0,r.jsx)(n.h2,{id:"r\xf4le-dans-la-stack",children:"R\xf4le dans la stack"}),"\n",(0,r.jsxs)(n.p,{children:["Caddy est le ",(0,r.jsx)(n.strong,{children:"reverse proxy central"})," de la stack. Il est responsable de :"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"l'exposition des services via des sous-domaines"}),"\n",(0,r.jsx)(n.li,{children:"la gestion automatique des certificats TLS"}),"\n",(0,r.jsx)(n.li,{children:"le routage HTTP/HTTPS"}),"\n",(0,r.jsxs)(n.li,{children:["l'int\xe9gration avec ",(0,r.jsx)(n.strong,{children:"Authelia"})," pour l'authentification (forward-auth)"]}),"\n",(0,r.jsx)(n.li,{children:"certaines r\xe8gles de s\xe9curit\xe9 de base (headers, robots, etc.)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Il constitue le ",(0,r.jsx)(n.strong,{children:"point d'entr\xe9e unique"})," vers tous les services expos\xe9s publiquement."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"position-dans-larchitecture",children:"Position dans l'architecture"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Internet\n   \u2502\n   \u25bc\nCaddy (TLS, routing)\n   \u2502\n   \u251c\u2500\u25ba Authelia (auth / authorization)\n   \u2514\u2500\u25ba Services internes (Umami, Directus, Immich, Docusaurus, etc.)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Tous les services HTTP passent ",(0,r.jsx)(n.strong,{children:"obligatoirement"})," par Caddy."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"responsabilit\xe9s-principales",children:"Responsabilit\xe9s principales"}),"\n",(0,r.jsx)(n.h3,{id:"reverse-proxy",children:"Reverse Proxy"}),"\n",(0,r.jsx)(n.p,{children:"Caddy route les requ\xeates entrantes vers les bons services Docker en fonction du nom de domaine :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"example.com"})," \u2192 site principal (Astro)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"wiki.example.com"})," \u2192 Docusaurus"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"photo.example.com"})," \u2192 Immich"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"admin.example.com"})," \u2192 Directus"]}),"\n",(0,r.jsx)(n.li,{children:"etc."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Chaque service est accessible uniquement via son sous-domaine."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"tls-automatique",children:"TLS automatique"}),"\n",(0,r.jsx)(n.p,{children:"Caddy g\xe8re automatiquement :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"la g\xe9n\xe9ration des certificats TLS"}),"\n",(0,r.jsx)(n.li,{children:"le renouvellement"}),"\n",(0,r.jsx)(n.li,{children:"le stockage"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Aucune gestion manuelle de certificats n'est n\xe9cessaire c\xf4t\xe9 services."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"authentification-avec-authelia",children:"Authentification avec Authelia"}),"\n",(0,r.jsxs)(n.p,{children:["Pour les services prot\xe9g\xe9s, Caddy utilise le module ",(0,r.jsx)(n.strong,{children:"forward_auth"})," vers Authelia via un snippet Caddy:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddy",children:"(secure) {\n  forward_auth {args[0]} authelia:9091 {\n    uri /api/authz/forward-auth\n    copy_headers Remote-User Remote-Groups Remote-Name Remote-Email\n  }\n}\n\nhttps://home.{$SERVER_NAME} {\n  import secure * # Securise tout le sous-domaine\n  ...\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Cela permet :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"l'authentification centralis\xe9e (OIDC / session)"}),"\n",(0,r.jsx)(n.li,{children:"la gestion fine des acc\xe8s par service"}),"\n",(0,r.jsxs)(n.li,{children:["l'exclusion de certaines routes publiques (ex: ",(0,r.jsx)(n.code,{children:"/script.js"})," pour Umami)"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"gestion-des-routes-publiques",children:"Gestion des routes publiques"}),"\n",(0,r.jsx)(n.p,{children:"Certaines routes doivent rester accessibles sans authentification (ex: assets, endpoints publics)."}),"\n",(0,r.jsx)(n.p,{children:"Exemple :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddy",children:"https://umami.{$SERVER_NAME} {\n  @needAuth not {\n    path <path1> <path2>\n  }\n  import secure @needAuth # Bypass certaines routes qui ont besoin d'un acc\xe8s public\n  ...\n\n  reverse_proxy <service>:<post>\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ce m\xe9canisme est utilis\xe9 notamment pour :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Umami (",(0,r.jsx)(n.code,{children:"/script.js"}),", ",(0,r.jsx)(n.code,{children:"/api/send"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"Webhooks publics"}),"\n",(0,r.jsx)(n.li,{children:"endpoints techniques"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"s\xe9curit\xe9-et-bonnes-pratiques",children:"S\xe9curit\xe9 et bonnes pratiques"}),"\n",(0,r.jsx)(n.p,{children:"Caddy applique \xe9galement :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"des headers HTTP communs"}),"\n",(0,r.jsxs)(n.li,{children:["des r\xe8gles ",(0,r.jsx)(n.code,{children:"no-robots"})," pour les services internes"]}),"\n",(0,r.jsx)(n.li,{children:"une s\xe9paration stricte entre services publics et priv\xe9s"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Ces r\xe8gles sont factoris\xe9es via des snippets import\xe9s :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddy",children:"import main\nimport no-robots\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"int\xe9gration-docker",children:"Int\xe9gration Docker"}),"\n",(0,r.jsx)(n.h3,{id:"r\xe9seau",children:"R\xe9seau"}),"\n",(0,r.jsxs)(n.p,{children:["Caddy est connect\xe9 au r\xe9seau Docker ",(0,r.jsx)(n.code,{children:"proxy-network"}),", partag\xe9 avec les services expos\xe9s."]}),"\n",(0,r.jsx)(n.p,{children:"Cela permet :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"un routage interne par nom de service Docker"}),"\n",(0,r.jsx)(n.li,{children:"aucune exposition directe des ports internes"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"ports-expos\xe9s",children:"Ports expos\xe9s"}),"\n",(0,r.jsxs)(n.p,{children:["Caddy est le seul service exposant (hors ",(0,r.jsx)(n.code,{children:"db"})," pour des questions de debug) :"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"80"})," (HTTP)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"443"})," (HTTPS)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Tous les autres services restent isol\xe9s du r\xe9seau externe."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"avantages-de-ce-setup",children:"Avantages de ce setup"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Un seul point d'entr\xe9e"}),"\n",(0,r.jsx)(n.li,{children:"TLS automatique et fiable"}),"\n",(0,r.jsx)(n.li,{children:"Authentification centralis\xe9e"}),"\n",(0,r.jsx)(n.li,{children:"Stack lisible et maintenable"}),"\n",(0,r.jsx)(n.li,{children:"Tr\xe8s faible complexit\xe9 c\xf4t\xe9 services"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"points-dattention",children:"Points d'attention"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Toute erreur dans le ",(0,r.jsx)(n.code,{children:"Caddyfile"})," peut impacter plusieurs services"]}),"\n",(0,r.jsx)(n.li,{children:"Caddy est un composant critique (single point of failure)"}),"\n",(0,r.jsx)(n.li,{children:"Les r\xe8gles d'authentification doivent \xeatre test\xe9es avec soin"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"am\xe9liorations-possibles",children:"Am\xe9liorations possibles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Ajout de rate limiting"}),"\n",(0,r.jsx)(n.li,{children:"Monitoring sp\xe9cifique de Caddy (metrics)"}),"\n",(0,r.jsx)(n.li,{children:"Logs centralis\xe9s"}),"\n",(0,r.jsx)(n.li,{children:"Backups du storage TLS"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"r\xe9sum\xe9",children:"R\xe9sum\xe9"}),"\n",(0,r.jsxs)(n.p,{children:["Caddy est la ",(0,r.jsx)(n.strong,{children:"colonne vert\xe9brale HTTP"})," de la stack."]}),"\n",(0,r.jsx)(n.p,{children:"Il simplifie fortement :"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"la s\xe9curit\xe9"}),"\n",(0,r.jsx)(n.li,{children:"la gestion TLS"}),"\n",(0,r.jsx)(n.li,{children:"l'exposition des services"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Tout en restant l\xe9ger, lisible et tr\xe8s bien int\xe9gr\xe9 \xe0 Docker et Authelia."}),"\n",(0,r.jsx)(n.h2,{id:"caddyfile--conventions-du-repository",children:"Caddyfile \u2013 Conventions du repository"}),"\n",(0,r.jsxs)(n.p,{children:["Cette stack utilise une organisation stricte du ",(0,r.jsx)(n.strong,{children:"Caddyfile"})," afin de rester lisible, maintenable et coh\xe9rente entre les environnements (dev / prod)."]}),"\n",(0,r.jsx)(n.h3,{id:"principes-g\xe9n\xe9raux",children:"Principes g\xe9n\xe9raux"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Un sous-domaine = un bloc Caddy"})}),"\n",(0,r.jsxs)(n.li,{children:["Les r\xe8gles communes sont ",(0,r.jsx)(n.strong,{children:"factoris\xe9es via des snippets"})," (",(0,r.jsx)(n.code,{children:"import"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["L\u2019authentification Authelia est ",(0,r.jsx)(n.strong,{children:"opt\u2011in"})," (activ\xe9e uniquement l\xe0 o\xf9 n\xe9cessaire)"]}),"\n",(0,r.jsxs)(n.li,{children:["Le Caddyfile est pens\xe9 pour \xeatre ",(0,r.jsx)(n.strong,{children:"lisible dans un repo public"})," (pas de secrets en dur)"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"structure-globale",children:"Structure globale"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddyfile",children:'{\n  {$CADDY_GLOBAL_OPTIONS}\n}\n\n# Snippets partag\xe9s\n(main) {\n  # headers communs\n}\n\n(no-robots) {\n  header X-Robots-Tag "noindex, nofollow"\n}\n\n(authelia-auth) {\n  forward_auth authelia:9091 {\n    uri /api/authz/forward-auth\n    copy_headers Remote-User Remote-Groups Remote-Name Remote-Email\n  }\n}\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"convention-par-service",children:"Convention par service"}),"\n",(0,r.jsx)(n.p,{children:"Chaque service suit ce pattern :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddyfile",children:"https://service.{$SERVER_NAME} {\n  import main\n\n  # Auth (si n\xe9cessaire)\n  import authelia-auth <path>\n\n  reverse_proxy <service>:<port>\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var i=s(6540);const r={},t=i.createContext(r);function l(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);