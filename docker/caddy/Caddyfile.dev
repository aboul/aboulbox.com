{
	{$CADDY_GLOBAL_OPTIONS}
	admin 0.0.0.0:2019
}

(main) {
	log_skip /assets*
	log {
		output file /var/log/caddy/access.json
		format json {
			time_format wall
		}
	}
}

(static) {
	@static {
		path *.ico *.css *.js *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.json *.tsx
	}
	header @static ?Cache-Control "public, max-age=432000, must-revalidate"
}

(no-robots) {
	handle /robots.txt {
		respond 200 {
			body "User-agent: *
			Disallow: /

			User-agent: AdsBot-Google
			Disallow: /

			User-agent: AdsBot-Google-Mobile
			Disallow: /"
			close
		}
	}
}

(security) {
	header {
		# enable HSTS
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		# disable clients from sniffing the media type
		X-Content-Type-Options nosniff
		# keep referrer data off of HTTP connections
		Referrer-Policy no-referrer-when-downgrade
		# disable FLoC tracking
		Permissions-Policy interest-cohort=()
		# Enable cross-site filter (XSS)
		# and tell browser to block detected attacks
		#Content-Security-Policy "default-src 'self' *.{$SERVER_NAME} 'nonce-random'; style-src 'self' *.{$SERVER_NAME} 'nonce-random'; script-src 'self' *.{$SERVER_NAME} 'nonce-random'; font-src 'self' 'nonce-random'; img-src 'self' 'nonce-random'; form-action 'self' 'nonce-random'; connect-src 'self' *.{$SERVER_NAME} 'nonce-random'; frame-ancestors 'none'; worker-src 'self' blob:"
		# prevent clickjacking
		X-Frame-Options: DENY
	}
}

https://{$SERVER_NAME:localhost} {
	import main
	import security
	import static
	encode zstd gzip

	# Handle API requests
	handle /api* {
		import security
		reverse_proxy backend:3001
	}

	@not_excluded { 
		not path *.* /@*
	}

	@not_404 { 
		not path /404 /
	}

	@404 {
		path /404
	}

	handle @not_excluded {
		handle @not_404 {
			redir @not_404 /404
		}

		reverse_proxy @404 frontend:3000 {
			replace_status 404
		}
	}

	reverse_proxy frontend:3000
}

https://umami.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy umami:3000
}

https://home.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy homepage:3000
}

https://wiki.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy docusaurus:3000
}

https://photo.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy immich:2283
}

https://admin.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy directus:8055
}

https://music.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy navidrome:4533
}

https://audiomuse.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy audiomuse-ai-flask:8000
}

https://ollama.{$SERVER_NAME:localhost} {
	import main
	import no-robots
	reverse_proxy ollama-webui:8080
}

https://monitor.{$SERVER_NAME} {
	import main
	import no-robots
	reverse_proxy glances:61208
}
